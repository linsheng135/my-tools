<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小说标题处理工具 - 手机优化版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
    
    body { 
        background-color: #f5f7fa; 
        color: #333; 
        line-height: 1.6;
        padding: 15px; 
        max-width: 100%; 
        margin: 0 auto;
        font-size: 16px;
    }
    
    .container { display: flex; flex-direction: column; gap: 20px; }
    
    header { 
        text-align: center; 
        padding: 18px 15px; 
        background: linear-gradient(135deg, #9C27B0 0%, #673AB7 100%); 
        border-radius: 12px; 
        color: white; 
        box-shadow: 0 4px 12px rgba(156, 39, 176, 0.15);
        margin-bottom: 5px;
    }
    
    h1 { font-size: 1.6rem; margin-bottom: 5px; font-weight: 700; }
    
    .subtitle { font-size: 0.95rem; opacity: 0.9; max-width: 100%; margin: 0 auto; }
    
    /* 移动端优化 */
    .main-content { 
        display: flex; 
        flex-direction: column; 
        gap: 20px;
    }
    
    /* 标题输入框放在顶部 */
    .custom-section { 
        background-color: white;
        border-radius: 12px; 
        padding: 18px; 
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        width: 100%;
        order: 1;
    }
    
    /* 标题列表在下面 */
    .titles-section { 
        background-color: white;
        border-radius: 12px; 
        padding: 18px; 
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        width: 100%;
        order: 2;
    }
    
    .section-title { 
        font-size: 1.4rem; 
        margin-bottom: 12px; 
        color: #2c3e50; 
        border-bottom: 3px solid #9C27B0; 
        padding-bottom: 8px; 
        display: flex;
        align-items: center; 
        gap: 8px;
    }
    
    .section-title i { color: #9C27B0; }
    
    /* 统计信息样式 */
    .stats-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
        font-size: 0.9rem;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #666;
    }
    
    .stat-value {
        font-weight: 600;
        color: #9C27B0;
    }
    
    .edited-count {
        color: #FF9800;
        font-weight: 600;
    }
    
    /* 标题项样式优化 */
    .title-item { 
        display: flex; 
        flex-direction: column;
        padding: 15px; 
        margin-bottom: 12px;
        background-color: #f8f9fa; 
        border-radius: 10px; 
        border-left: 5px solid #9C27B0; 
        transition: all 0.3s ease;
        position: relative;
    }
    
    .title-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08); }
    
    .title-item.edited { border-left-color: #FF9800; background-color: #FFF8E1; }
    
    .title-item.selected { background-color: #e6f7ff; }
    
    .title-content { width: 100%; margin-bottom: 10px; }
    
    .title-text { 
        font-size: 1.1rem; 
        color: #2c3e50; 
        margin-bottom: 5px; 
        display: block; 
        word-break: break-all;
        line-height: 1.4;
        min-height: 24px;
    }
    
    /* 字数统计样式 */
    .char-count { 
        font-size: 0.85rem; 
        color: #7f8c8d; 
        display: flex; 
        align-items: center;
        gap: 5px;
        margin-top: 5px;
    }
    
    .char-count i { font-size: 0.8rem; }
    
    .title-input { 
        width: 100%; 
        padding: 12px; 
        border: 2px solid #E0E0E0; 
        border-radius: 8px; 
        font-size: 1rem; 
        margin-bottom: 10px; 
        display: none;
        box-sizing: border-box;
    }
    
    .title-input:focus { outline: none; border-color: #9C27B0; }
    
    /* 输入框字数统计 */
    .input-char-count {
        font-size: 0.85rem;
        color: #7f8c8d;
        text-align: right;
        margin-top: 5px;
        display: none;
    }
    
    /* 标题操作区域优化 */
    .title-actions { 
        display: flex; 
        flex-wrap: wrap;
        gap: 8px; 
        align-items: center;
        width: 100%;
        margin-top: 5px;
    }
    
    /* 快速操作按钮区域 */
    .quick-actions { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 8px; 
        margin-bottom: 15px;
        justify-content: space-between;
    }
    
    .quick-action-btn {
        padding: 10px 12px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 1;
        justify-content: center;
        min-width: 0;
        white-space: nowrap;
    }
    
    .quick-action-btn:hover { background-color: #e0e0e0; }
    
    /* 按钮通用样式 */
    .copy-btn, .edit-btn, .save-btn, .cancel-btn {
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 0.95rem;
        min-width: 70px;
    }
    
    .copy-btn { 
        background: linear-gradient(to right, #9C27B0, #673AB7);
        color: white; 
        flex: 1;
    }
    
    .copy-btn:hover { background: linear-gradient(to right, #8A1CA0, #5C2FA7); }
    
    .copy-btn.copied { background: linear-gradient(to right, #2ecc71, #27ae60); }
    
    .edit-btn { 
        background-color: #FF9800;
        color: white; 
        flex: 1;
    }
    
    .edit-btn:hover { background-color: #F57C00; }
    
    .save-btn { 
        background-color: #4CAF50;
        color: white; 
        flex: 1;
        display: none;
    }
    
    .save-btn:hover { background-color: #388E3C; }
    
    .cancel-btn { 
        background-color: #F44336;
        color: white; 
        flex: 1;
        display: none;
    }
    
    .cancel-btn:hover { background-color: #D32F2F; }
    
    /* 复选框样式优化 */
    .title-checkbox {
        width: 20px;
        height: 20px;
        margin-right: 10px;
    }
    
    /* 编辑指示器 */
    .edit-indicator { 
        font-size: 0.8rem; 
        color: #FF9800; 
        display: flex;
        align-items: center; 
        gap: 5px; 
        display: none;
        margin-top: 5px;
    }
    
    /* 自定义文本区域 */
    .custom-textarea { 
        width: 100%; 
        height: 180px; 
        padding: 15px; 
        border: 2px solid #e0e0e0; 
        border-radius: 10px; 
        font-size: 1rem; 
        resize: vertical; 
        margin-bottom: 15px; 
        transition: border-color 0.3s;
        box-sizing: border-box;
    }
    
    .custom-textarea:focus { outline: none; border-color: #9C27B0; }
    
    /* 按钮组优化 */
    .btn-group { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 10px; 
        margin-top: 15px;
        justify-content: space-between;
    }
    
    .action-btn {
        padding: 14px 18px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 1rem;
        flex: 1;
        min-width: 0;
    }
    
    .primary-btn { 
        background: linear-gradient(to right, #9C27B0, #673AB7);
        color: white; 
    }
    
    .secondary-btn { 
        background-color: #f8f9fa; 
        color: #2c3e50; 
        border: 2px solid #e0e0e0; 
    }
    
    .excel-btn { 
        background: linear-gradient(to right, #217346, #1e7e34);
        color: white; 
    }
    
    .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    
    /* 底部复制选中按钮区域 */
    .copy-selected-section {
        background-color: white;
        border-radius: 12px;
        padding: 18px;
        margin-top: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        order: 3;
    }
    
    .copy-selected-btn {
        padding: 16px 20px;
        background: linear-gradient(to right, #3498db, #2980b9);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        width: 100%;
    }
    
    .copy-selected-btn:hover {
        background: linear-gradient(to right, #2980b9, #1c6ea4);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    
    /* Excel导出区域 */
    .excel-section { 
        margin-top: 20px; 
        padding-top: 20px; 
        border-top: 1px solid #eee; 
    }
    
    .excel-tip { 
        background-color: #e8f6f3; 
        border-radius: 8px; 
        padding: 15px; 
        margin-top: 15px; 
        border-left: 4px solid #2ecc71; 
    }
    
    .excel-tip h4 { 
        color: #27ae60; 
        margin-bottom: 8px; 
        display: flex;
        align-items: center; 
        gap: 8px; 
        font-size: 1.1rem;
    }
    
    .excel-tip p { margin-bottom: 5px; color: #2c3e50; }
    
    .csv-info { 
        display: flex; 
        align-items: center; 
        gap: 10px;
        margin-bottom: 15px; 
        padding: 10px; 
        background-color: #f9f9f9;
        border-radius: 8px; 
        font-size: 0.95rem;
    }
    
    .csv-info i { color: #9C27B0; font-size: 1.2rem; }
    
    /* 使用指南 */
    .instructions { 
        background-color: #e8f4fc; 
        border-radius: 10px; 
        padding: 20px; 
        margin-top: 20px; 
        border-left: 5px solid #673AB7; 
        font-size: 0.95rem;
    }
    
    .instructions h3 { 
        color: #2c3e50; 
        margin-bottom: 15px; 
        display: flex;
        align-items: center; 
        gap: 10px; 
        font-size: 1.3rem;
    }
    
    .instructions ol { padding-left: 20px; }
    
    .instructions li { margin-bottom: 8px; }
    
    /* 通知 */
    .notification { 
        position: fixed; 
        bottom: 20px; 
        right: 20px;
        left: 20px;
        background-color: #2ecc71; 
        color: white; 
        padding: 15px 20px;
        border-radius: 8px; 
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(100px); 
        opacity: 0; 
        transition: all 0.5s ease;
        z-index: 1000; 
        text-align: center;
        font-size: 0.95rem;
    }
    
    .notification.show { transform: translateY(0); opacity: 1; }
    
    .notification.error { background-color: #e74c3c; }
    
    /* 页脚 */
    footer { 
        text-align: center; 
        margin-top: 30px; 
        padding-top: 20px;
        border-top: 1px solid #e0e0e0; 
        color: #7f8c8d; 
        font-size: 0.85rem; 
    }
    
    /* 移动端响应式调整 */
    @media (max-width: 768px) {
        body { padding: 12px; }
        
        header { padding: 15px 12px; }
        
        h1 { font-size: 1.5rem; }
        
        .section-title { font-size: 1.3rem; }
        
        .title-item { padding: 12px; }
        
        .title-text { font-size: 1.05rem; }
        
        .custom-textarea { height: 150px; padding: 12px; }
        
        .action-btn, .copy-selected-btn { padding: 12px 15px; font-size: 0.95rem; }
        
        .copy-btn, .edit-btn, .save-btn, .cancel-btn { 
            padding: 8px 12px; 
            font-size: 0.9rem;
            min-width: 60px;
        }
        
        .quick-action-btn { padding: 8px 10px; font-size: 0.85rem; }
        
        .notification { 
            left: 12px; 
            right: 12px; 
            bottom: 12px; 
            padding: 12px 15px;
        }
    }
    
    @media (max-width: 480px) {
        .quick-actions { gap: 6px; }
        
        .quick-action-btn { 
            padding: 8px 6px; 
            font-size: 0.8rem;
            gap: 4px;
        }
        
        .btn-group { gap: 8px; }
        
        .action-btn { 
            padding: 12px 10px; 
            font-size: 0.9rem;
            gap: 5px;
        }
        
        .title-actions { gap: 6px; }
        
        .copy-btn, .edit-btn, .save-btn, .cancel-btn { 
            padding: 8px 10px;
            font-size: 0.85rem;
            gap: 4px;
        }
        
        .title-checkbox { margin-right: 6px; }
    }
    
    /* 编辑功能说明 */
    .edit-instructions {
        margin-top: 20px; 
        padding: 15px; 
        background-color: #F3E5F5; 
        border-radius: 8px; 
        border-left: 4px solid #9C27B0; 
        font-size: 0.9rem;
    }
    
    .edit-instructions h4 { 
        color: #7B1FA2; 
        margin-bottom: 10px; 
        display: flex;
        align-items: center; 
        gap: 8px;
        font-size: 1.1rem;
    }
    
    .edit-instructions ul { padding-left: 20px; }
    
    .edit-instructions li { margin-bottom: 6px; color: #5D4037; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-edit"></i> 小说标题处理工具</h1>
            <p class="subtitle">手机优化版 | 支持标题编辑、字数统计、批量复制导出</p>
        </header>
        
        <div class="main-content">
            <!-- 自定义标题输入框放在顶部 -->
            <section class="custom-section">
                <h2 class="section-title"><i class="fas fa-edit"></i> 标题输入框</h2>
                <p style="margin-bottom: 15px; color: #555; font-size: 0.95rem;">每行输入一个标题，点击"更新列表"按钮添加到下方</p>
                
                <textarea class="custom-textarea" id="customTitles" placeholder="请在此输入标题，每行一个...&#10;例如：&#10;霸道总裁爱上我&#10;重生之逆袭人生&#10;都市异能神医"></textarea>
                
                <div class="btn-group">
                    <button class="action-btn primary-btn" id="updateTitlesBtn">
                        <i class="fas fa-sync-alt"></i> 更新列表
                    </button>
                    <button class="action-btn secondary-btn" id="clearTitlesBtn">
                        <i class="fas fa-trash-alt"></i> 清空列表
                    </button>
                </div>
            </section>
            
            <!-- 标题列表 -->
            <section class="titles-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title">
                        <i class="fas fa-book"></i> 标题列表
                    </h2>
                </div>
                
                <!-- 统计信息 -->
                <div class="stats-info">
                    <div class="stat-item">
                        <i class="fas fa-list"></i>
                        <span>标题总数: <span class="stat-value" id="titleCount">0</span></span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-edit"></i>
                        <span>已编辑: <span class="stat-value edited-count" id="editedCount">0</span></span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-check-square"></i>
                        <span>已选中: <span class="stat-value" id="selectedCount">0</span></span>
                    </div>
                </div>
                
                <!-- 快速操作按钮 -->
                <div class="quick-actions">
                    <button class="quick-action-btn" id="selectAllBtn">
                        <i class="fas fa-check-square"></i> 全选
                    </button>
                    <button class="quick-action-btn" id="deselectAllBtn">
                        <i class="fas fa-square"></i> 取消
                    </button>
                    <button class="quick-action-btn" id="saveAllEditsBtn">
                        <i class="fas fa-save"></i> 保存全部
                    </button>
                    <button class="quick-action-btn" id="discardAllEditsBtn">
                        <i class="fas fa-undo"></i> 撤销全部
                    </button>
                </div>
                
                <!-- 标题容器 -->
                <div id="titlesContainer">
                    <!-- 标题会通过JavaScript动态添加 -->
                    <div style="text-align: center; padding: 40px 20px; color: #999; background-color: #f9f9f9; border-radius: 10px;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>暂无标题</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">请在顶部输入框中添加标题</p>
                    </div>
                </div>
                
                <!-- Excel导出工具 -->
                <div class="excel-section">
                    <h3><i class="fas fa-file-excel"></i> 导出工具</h3>
                    
                    <div class="csv-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>导出说明：</strong>
                            CSV文件只包含标题列，可直接粘贴到Excel的A列
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="action-btn excel-btn" id="copyAllBtn">
                            <i class="fas fa-copy"></i> 复制全部
                        </button>
                        <button class="action-btn excel-btn" id="exportCSVBtn">
                            <i class="fas fa-file-export"></i> 导出CSV
                        </button>
                    </div>
                    
                    <div class="excel-tip">
                        <h4><i class="fas fa-lightbulb"></i> Excel使用技巧</h4>
                        <p><strong>自动调整列宽：</strong> 在Excel中，双击A列右侧的边界线即可自动调整列宽</p>
                        <p><strong>快捷键：</strong> 选中A列后按 <kbd>Alt</kbd> + <kbd>H</kbd> + <kbd>O</kbd> + <kbd>I</kbd> 快速调整列宽</p>
                    </div>
                </div>
            </section>
            
            <!-- 复制选中按钮放在底部 -->
            <section class="copy-selected-section">
                <button class="copy-selected-btn" id="copySelectedBtn">
                    <i class="fas fa-copy"></i> 复制选中标题 (<span id="selectedCountBig">0</span>)
                </button>
                <p style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9rem;">将选中的所有标题复制到剪贴板，每行一个</p>
            </section>
        </div>
        
        <!-- 编辑功能说明 -->
        <div class="edit-instructions">
            <h4><i class="fas fa-pen"></i> 编辑功能说明</h4>
            <ul>
                <li>点击标题旁边的"编辑"按钮可修改标题</li>
                <li>修改后点击"保存"按钮保存修改，或"取消"按钮放弃修改</li>
                <li>复制按钮会复制当前显示（已编辑）的标题</li>
                <li>编辑后的标题会以橙色边框标记</li>
                <li>使用"保存全部"按钮可以一次性保存所有编辑</li>
                <li>使用"撤销全部"可以恢复所有标题到原始状态</li>
            </ul>
        </div>
        
        <!-- 使用指南 -->
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> 使用指南</h3>
            <ol>
                <li><strong>添加标题：</strong> 在顶部输入框中输入标题，每行一个，点击"更新列表"</li>
                <li><strong>编辑标题：</strong> 点击标题旁边的"编辑"按钮，修改标题内容，然后点击"保存"</li>
                <li><strong>复制标题：</strong> 单个标题点击"复制"，批量复制请勾选标题后点击底部"复制选中标题"</li>
                <li><strong>导出到Excel：</strong> 点击"导出CSV"按钮，用Excel打开后自动调整列宽</li>
                <li><strong>字数统计：</strong> 每个标题下方会显示字数，编辑保存后自动更新</li>
            </ol>
        </div>
        
        <footer>
            <p>小说标题处理工具 &copy; 2023 | 手机优化版 v2.0 | 专为手机端使用设计</p>
        </footer>
    </div>
    
    <div class="notification" id="notification">标题已复制到剪贴板！</div>

    <script>
    // 默认标题列表 - 清空默认标题
    const defaultTitles = [];
    
    // 当前显示的标题列表（包含编辑后的标题）
    let currentTitles = [...defaultTitles];
    
    // 原始标题列表（未编辑的版本）
    let originalTitles = [...defaultTitles];
    
    // 编辑状态跟踪
    let editedTitles = new Set();
    
    // 选中的标题索引
    let selectedTitles = new Set();
    
    // 初始化显示标题
    document.addEventListener('DOMContentLoaded', function() {
        renderTitles();
        
        // 更新标题列表按钮事件
        document.getElementById('updateTitlesBtn').addEventListener('click', updateTitles);
        
        // 清空标题列表按钮事件
        document.getElementById('clearTitlesBtn').addEventListener('click', clearTitles);
        
        // 复制全部标题按钮事件
        document.getElementById('copyAllBtn').addEventListener('click', copyAllTitles);
        
        // 导出CSV按钮事件（导出编辑后的标题）
        document.getElementById('exportCSVBtn').addEventListener('click', exportToCSV);
        
        // 全选按钮事件
        document.getElementById('selectAllBtn').addEventListener('click', selectAllTitles);
        
        // 取消全选按钮事件
        document.getElementById('deselectAllBtn').addEventListener('click', deselectAllTitles);
        
        // 复制选中按钮事件
        document.getElementById('copySelectedBtn').addEventListener('click', copySelectedTitles);
        
        // 保存所有编辑按钮事件
        document.getElementById('saveAllEditsBtn').addEventListener('click', saveAllEdits);
        
        // 撤销所有编辑按钮事件
        document.getElementById('discardAllEditsBtn').addEventListener('click', discardAllEdits);
        
        // 显示标题数量
        updateTitleCount();
        updateSelectedCount();
    });
    
    // 渲染标题列表
    function renderTitles() {
        const container = document.getElementById('titlesContainer');
        
        if (currentTitles.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #999; background-color: #f9f9f9; border-radius: 10px;">
                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>暂无标题</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">请在顶部输入框中添加标题</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        currentTitles.forEach((title, index) => {
            const isEdited = editedTitles.has(index);
            const originalTitle = originalTitles[index];
            const charCount = getCharCount(title);
            
            const titleElement = document.createElement('div');
            titleElement.className = `title-item ${isEdited ? 'edited' : ''} ${selectedTitles.has(index) ? 'selected' : ''}`;
            titleElement.dataset.index = index;
            
            titleElement.innerHTML = `
                <div class="title-content">
                    <span class="title-text" id="titleText-${index}">${title}</span>
                    <input type="text" class="title-input" id="titleInput-${index}" 
                           value="${title}" data-original="${originalTitle}" 
                           oninput="updateInputCharCount(${index})">
                    <div class="input-char-count" id="inputCharCount-${index}">0字</div>
                    
                    <div class="char-count" id="charCount-${index}">
                        <i class="fas fa-font"></i> ${charCount}字
                    </div>
                    
                    <span class="edit-indicator" id="editIndicator-${index}">
                        <i class="fas fa-pen"></i> 已编辑
                    </span>
                </div>
                
                <div class="title-actions">
                    <input type="checkbox" class="title-checkbox" id="checkbox-${index}" 
                           data-index="${index}" ${selectedTitles.has(index) ? 'checked' : ''}>
                    
                    <button class="edit-btn" id="editBtn-${index}" data-index="${index}">
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                    
                    <button class="save-btn" id="saveBtn-${index}" data-index="${index}">
                        <i class="fas fa-check"></i> 保存
                    </button>
                    
                    <button class="cancel-btn" id="cancelBtn-${index}" data-index="${index}">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    
                    <button class="copy-btn" id="copyBtn-${index}" data-index="${index}">
                        <i class="fas fa-copy"></i> 复制
                    </button>
                </div>
            `;
            
            container.appendChild(titleElement);
            
            // 如果已编辑，显示编辑指示器
            if (isEdited) {
                document.getElementById(`editIndicator-${index}`).style.display = 'flex';
            }
        });
        
        // 为所有按钮添加事件
        setupEventListeners();
        
        // 更新统计信息
        updateTitleCount();
        updateEditedCount();
        updateSelectedCount();
    }
    
    // 设置事件监听器
    function setupEventListeners() {
        // 为所有编辑按钮添加事件
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                enterEditMode(index);
            });
        });
        
        // 为所有保存按钮添加事件
        document.querySelectorAll('.save-btn').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                saveEdit(index);
            });
        });
        
        // 为所有取消按钮添加事件
        document.querySelectorAll('.cancel-btn').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                cancelEdit(index);
            });
        });
        
        // 为所有复制按钮添加事件
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                copyTitle(index, this);
            });
        });
        
        // 为所有复选框添加事件
        document.querySelectorAll('.title-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const index = parseInt(this.getAttribute('data-index'));
                const titleItem = this.closest('.title-item');
                
                if (this.checked) {
                    selectedTitles.add(index);
                    titleItem.classList.add('selected');
                } else {
                    selectedTitles.delete(index);
                    titleItem.classList.remove('selected');
                }
                
                updateSelectedCount();
            });
        });
        
        // 为所有输入框添加回车键保存功能
        document.querySelectorAll('.title-input').forEach(input => {
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const index = parseInt(this.id.replace('titleInput-', ''));
                    saveEdit(index);
                } else if (e.key === 'Escape') {
                    const index = parseInt(this.id.replace('titleInput-', ''));
                    cancelEdit(index);
                }
            });
        });
    }
    
    // 更新输入框字数统计
    function updateInputCharCount(index) {
        const inputElement = document.getElementById(`titleInput-${index}`);
        const charCountElement = document.getElementById(`inputCharCount-${index}`);
        const count = getCharCount(inputElement.value);
        charCountElement.textContent = `${count}字`;
    }
    
    // 获取字符数
    function getCharCount(text) {
        return text.length;
    }
    
    // 进入编辑模式
    function enterEditMode(index) {
        // 显示输入框，隐藏文本
        document.getElementById(`titleText-${index}`).style.display = 'none';
        document.getElementById(`titleInput-${index}`).style.display = 'block';
        document.getElementById(`inputCharCount-${index}`).style.display = 'block';
        
        // 显示保存和取消按钮，隐藏编辑按钮
        document.getElementById(`editBtn-${index}`).style.display = 'none';
        document.getElementById(`saveBtn-${index}`).style.display = 'inline-flex';
        document.getElementById(`cancelBtn-${index}`).style.display = 'inline-flex';
        
        // 聚焦到输入框
        const inputElement = document.getElementById(`titleInput-${index}`);
        inputElement.focus();
        inputElement.select();
        
        // 更新输入框字数统计
        updateInputCharCount(index);
    }
    
    // 保存编辑
    function saveEdit(index) {
        const inputElement = document.getElementById(`titleInput-${index}`);
        const newTitle = inputElement.value.trim();
        const originalTitle = inputElement.getAttribute('data-original');
        
        if (newTitle === '') {
            showNotification('标题不能为空', true);
            return;
        }
        
        // 更新当前标题
        currentTitles[index] = newTitle;
        
        // 更新显示文本
        document.getElementById(`titleText-${index}`).textContent = newTitle;
        
        // 更新字数统计
        const charCount = getCharCount(newTitle);
        document.getElementById(`charCount-${index}`).innerHTML = `<i class="fas fa-font"></i> ${charCount}字`;
        
        // 如果标题与原始标题不同，标记为已编辑
        if (newTitle !== originalTitle) {
            editedTitles.add(index);
            document.getElementById(`editIndicator-${index}`).style.display = 'flex';
            document.querySelector(`.title-item[data-index="${index}"]`).classList.add('edited');
        } else {
            editedTitles.delete(index);
            document.getElementById(`editIndicator-${index}`).style.display = 'none';
            document.querySelector(`.title-item[data-index="${index}"]`).classList.remove('edited');
        }
        
        // 退出编辑模式
        exitEditMode(index);
        
        // 更新编辑计数
        updateEditedCount();
        
        showNotification(`标题 #${index + 1} 已保存`);
    }
    
    // 取消编辑
    function cancelEdit(index) {
        // 恢复原始值
        const inputElement = document.getElementById(`titleInput-${index}`);
        const originalTitle = inputElement.getAttribute('data-original');
        
        // 退出编辑模式
        exitEditMode(index);
        
        // 如果输入框的值已经改变，重置为原始值
        if (inputElement.value !== originalTitle) {
            inputElement.value = originalTitle;
            document.getElementById(`titleText-${index}`).textContent = originalTitle;
            currentTitles[index] = originalTitle;
            
            // 更新字数统计
            const charCount = getCharCount(originalTitle);
            document.getElementById(`charCount-${index}`).innerHTML = `<i class="fas fa-font"></i> ${charCount}字`;
            
            // 如果之前被标记为已编辑，现在取消编辑标记
            editedTitles.delete(index);
            document.getElementById(`editIndicator-${index}`).style.display = 'none';
            document.querySelector(`.title-item[data-index="${index}"]`).classList.remove('edited');
            
            // 更新编辑计数
            updateEditedCount();
            
            showNotification(`标题 #${index + 1} 的编辑已取消`);
        }
    }
    
    // 退出编辑模式
    function exitEditMode(index) {
        // 隐藏输入框，显示文本
        document.getElementById(`titleText-${index}`).style.display = 'block';
        document.getElementById(`titleInput-${index}`).style.display = 'none';
        document.getElementById(`inputCharCount-${index}`).style.display = 'none';
        
        // 显示编辑按钮，隐藏保存和取消按钮
        document.getElementById(`editBtn-${index}`).style.display = 'inline-flex';
        document.getElementById(`saveBtn-${index}`).style.display = 'none';
        document.getElementById(`cancelBtn-${index}`).style.display = 'none';
    }
    
    // 更新标题列表
    function updateTitles() {
        const textarea = document.getElementById('customTitles');
        const newTitles = textarea.value.trim().split('\n')
            .map(title => title.trim())
            .filter(title => title.length > 0);
        
        if (newTitles.length === 0) {
            showNotification('请输入至少一个标题', true);
            return;
        }
        
        currentTitles = [...newTitles];
        originalTitles = [...newTitles];
        editedTitles.clear();
        selectedTitles.clear();
        
        renderTitles();
        showNotification(`已添加 ${newTitles.length} 个标题`);
    }
    
    // 清空标题列表
    function clearTitles() {
        if (currentTitles.length === 0) {
            showNotification('标题列表已是空的', true);
            return;
        }
        
        if (confirm('确定要清空所有标题吗？')) {
            currentTitles = [];
            originalTitles = [];
            editedTitles.clear();
            selectedTitles.clear();
            
            renderTitles();
            showNotification('已清空所有标题');
        }
    }
    
    // 全选标题
    function selectAllTitles() {
        if (currentTitles.length === 0) {
            showNotification('标题列表为空', true);
            return;
        }
        
        selectedTitles.clear();
        for (let i = 0; i < currentTitles.length; i++) {
            selectedTitles.add(i);
        }
        
        document.querySelectorAll('.title-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        
        document.querySelectorAll('.title-item').forEach(item => {
            item.classList.add('selected');
        });
        
        updateSelectedCount();
        showNotification(`已全选 ${currentTitles.length} 个标题`);
    }
    
    // 取消全选
    function deselectAllTitles() {
        if (selectedTitles.size === 0) {
            showNotification('没有选中的标题', true);
            return;
        }
        
        selectedTitles.clear();
        
        document.querySelectorAll('.title-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        document.querySelectorAll('.title-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        updateSelectedCount();
        showNotification('已取消全选');
    }
    
    // 保存所有编辑
    function saveAllEdits() {
        if (editedTitles.size === 0) {
            showNotification('没有需要保存的编辑', true);
            return;
        }
        
        // 找出所有处于编辑模式的标题并保存
        let savedCount = 0;
        editedTitles.forEach(index => {
            // 如果该标题当前处于编辑模式，先保存
            const inputElement = document.getElementById(`titleInput-${index}`);
            if (inputElement && inputElement.style.display === 'block') {
                saveEdit(index);
                savedCount++;
            }
        });
        
        // 更新原始标题列表
        originalTitles = [...currentTitles];
        
        // 清除编辑标记
        editedTitles.clear();
        
        // 更新UI
        document.querySelectorAll('.edit-indicator').forEach(indicator => {
            indicator.style.display = 'none';
        });
        
        document.querySelectorAll('.title-item').forEach(item => {
            item.classList.remove('edited');
        });
        
        updateEditedCount();
        showNotification(`已保存所有编辑（${savedCount}个标题）`);
    }
    
    // 撤销所有编辑
    function discardAllEdits() {
        if (editedTitles.size === 0) {
            showNotification('没有需要撤销的编辑', true);
            return;
        }
        
        if (confirm(`确定要撤销所有编辑吗？这将恢复 ${editedTitles.size} 个标题的原始内容`)) {
            // 恢复所有已编辑的标题到原始状态
            editedTitles.forEach(index => {
                currentTitles[index] = originalTitles[index];
                
                // 更新显示文本
                document.getElementById(`titleText-${index}`).textContent = originalTitles[index];
                
                // 更新字数统计
                const charCount = getCharCount(originalTitles[index]);
                document.getElementById(`charCount-${index}`).innerHTML = `<i class="fas fa-font"></i> ${charCount}字`;
                
                // 清除编辑标记
                document.getElementById(`editIndicator-${index}`).style.display = 'none';
                document.querySelector(`.title-item[data-index="${index}"]`).classList.remove('edited');
            });
            
            // 清除编辑状态
            editedTitles.clear();
            
            // 退出所有编辑模式
            for (let i = 0; i < currentTitles.length; i++) {
                exitEditMode(i);
            }
            
            updateEditedCount();
            showNotification(`已撤销所有编辑（恢复 ${editedTitles.size} 个标题）`);
        }
    }
    
    // 复制单个标题
    function copyTitle(index, buttonElement = null) {
        const title = currentTitles[index];
        copyToClipboard(title, buttonElement);
        showNotification(`"${title.substring(0, 25)}${title.length > 25 ? '...' : ''}" 已复制到剪贴板！`);
    }
    
    // 复制所有标题
    function copyAllTitles() {
        if (currentTitles.length === 0) {
            showNotification('标题列表为空，请先添加标题', true);
            return;
        }
        
        const allTitles = currentTitles.join('\n');
        copyToClipboard(allTitles);
        showNotification(`已复制全部 ${currentTitles.length} 个标题到剪贴板`);
    }
    
    // 复制选中标题
    function copySelectedTitles() {
        if (selectedTitles.size === 0) {
            showNotification('请先选择要复制的标题', true);
            return;
        }
        
        const selected = Array.from(selectedTitles)
            .sort((a, b) => a - b)
            .map(index => currentTitles[index])
            .join('\n');
        
        copyToClipboard(selected);
        showNotification(`已复制 ${selectedTitles.size} 个选中标题到剪贴板`);
    }
    
    // 复制文本到剪贴板
    function copyToClipboard(text, buttonElement = null) {
        navigator.clipboard.writeText(text).then(() => {
            // 改变按钮状态
            if (buttonElement) {
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-check"></i> 已复制';
                buttonElement.classList.add('copied');
                
                // 2秒后恢复按钮状态
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            }
        }).catch(err => {
            console.error('复制失败: ', err);
            fallbackCopyTextToClipboard(text);
        });
    }
    
    // 备用复制方法
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showNotification(`"${text.substring(0, 20)}..." 已复制到剪贴板！`);
            } else {
                showNotification('复制失败，请手动选择文本复制', true);
            }
        } catch (err) {
            console.error('备用复制方法失败: ', err);
            showNotification('复制失败，请手动选择文本复制', true);
        }
        
        document.body.removeChild(textArea);
    }
    
    // 导出为CSV文件
    function exportToCSV() {
        if (currentTitles.length === 0) {
            showNotification('标题列表为空，请先添加标题', true);
            return;
        }
        
        // 创建CSV内容，只包含标题列，每行一个标题
        let csvContent = '';
        
        currentTitles.forEach(title => {
            // 处理标题中的特殊字符
            const needsQuotes = title.includes(',') || title.includes('"') || title.includes('\n');
            let escapedTitle = title;
            
            // 转义引号
            if (title.includes('"')) {
                escapedTitle = title.replace(/"/g, '""');
            }
            
            // 添加引号如果必要
            if (needsQuotes) {
                csvContent += `"${escapedTitle}"\n`;
            } else {
                csvContent += `${escapedTitle}\n`;
            }
        });
        
        // 创建Blob对象并下载
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        
        const dateStr = new Date().toISOString().split('T')[0];
        const editedCount = editedTitles.size;
        const fileName = `小说标题_${dateStr}_${currentTitles.length}个${editedCount > 0 ? '_已编辑' : ''}.csv`;
        
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification(`已导出 ${currentTitles.length} 个标题到CSV文件`);
    }
    
    // 更新标题数量显示
    function updateTitleCount() {
        document.getElementById('titleCount').textContent = currentTitles.length;
    }
    
    // 更新编辑数量显示
    function updateEditedCount() {
        const count = editedTitles.size;
        document.getElementById('editedCount').textContent = count;
    }
    
    // 更新选中数量显示
    function updateSelectedCount() {
        const count = selectedTitles.size;
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('selectedCountBig').textContent = count;
    }
    
    // 显示通知
    function showNotification(message, isError = false) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.classList.remove('error');
        
        if (isError) {
            notification.classList.add('error');
        }
        
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    </script>
</body>
</html>
